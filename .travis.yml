#*******************************************************************************
#.travis.yml
#*******************************************************************************

#Purpose:
#Travis CI is a hosted continuous integration service, that is, it allows 
#running code directly from a repository and checking that the code acts as 
#expected. The purpose of the .travis.yml file is to give instructions to Travis 
#CI on how to do the work.
#Authors:
#Alan D. Snow, 2016, based on initial .yml file by Cedric H. David


#*******************************************************************************
#System specifications for Travis CI
#*******************************************************************************
language: python
python:
  - "2.7"
notifications:
  email: false

#*******************************************************************************
#Before installing RAPIDpy
#*******************************************************************************
before_install:
- sudo apt-get update -qq
- sudo apt-get install -y g++ gfortran

#-------------------------------------------------------------------------------
#Add miniconda - from https://gist.github.com/dan-blanchard/7045057
#-------------------------------------------------------------------------------
- wget http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh
- chmod +x miniconda.sh
- ./miniconda.sh -b
- export PATH=$TRAVIS_BUILD_DIR/miniconda/bin:$PATH
- conda update --yes conda
- conda create --yes -n condaenv python=2.7
- conda install --yes -n condaenv pip
- source activate condaenv
# The next couple lines fix a crash with multiprocessing on Travis and are not specific to using Miniconda
- sudo rm -rf /dev/shm
- sudo ln -s /run/shm /dev/shm

#-------------------------------------------------------------------------------
#Creating directory for installation of libraries used by RAPIDpy
#-------------------------------------------------------------------------------
- cd $TRAVIS_BUILD_DIR
- mkdir ../installz
- cd ../installz
- export INSTALLZ_DIR=$PWD

#-------------------------------------------------------------------------------
# Installing NetCDF, GIS, SciPy libraries
#-------------------------------------------------------------------------------
- sudo apt-get install -y python-dev zlib1g-dev libhdf5-serial-dev libnetcdf-dev libproj-dev libgeos-dev

#install python packages
- conda install --yes python=$TRAVIS_PYTHON_VERSION nose numpy scipy
- pip install netCDF4 shapely pyproj rtree

#-------------------------------------------------------------------------------
#Installing netCDF 3.6.3
#-------------------------------------------------------------------------------
- cd $INSTALLZ_DIR
- wget "ftp://ftp.unidata.ucar.edu/pub/netcdf/netcdf-3.6.3.tar.gz"
- mkdir netcdf-3.6.3-install
- tar -xf netcdf-3.6.3.tar.gz
- cd netcdf-3.6.3
- ./configure --prefix=$INSTALLZ_DIR/netcdf-3.6.3-install
- make check
- make install

#-------------------------------------------------------------------------------
#Installing PETSc 3.6.2
#-------------------------------------------------------------------------------
- cd $INSTALLZ_DIR
- wget "http://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-3.6.2.tar.gz" 
- tar -xf petsc-3.6.2.tar.gz
- cd petsc-3.6.2
- ./configure PETSC_DIR=$PWD PETSC_ARCH=linux-gcc-cxx --download-fblaslapack=1 --download-mpich=1 --with-cc=gcc --with-cxx=g++ --with-fc=gfortran --with-clanguage=cxx --with-debugging=0
- make PETSC_DIR=$PWD PETSC_ARCH=linux-gcc-cxx all
- make PETSC_DIR=$PWD PETSC_ARCH=linux-gcc-cxx test

#-------------------------------------------------------------------------------
#Installing spatialindex
#-------------------------------------------------------------------------------
- cd $INSTALLZ_DIR
- wget "http://download.osgeo.org/libspatialindex/spatialindex-src-1.7.1.tar.gz"
- tar -xzf spatialindex-src-1.7.1.tar.gz
- cd spatialindex-src-1.7.1
- ./configure
- make
- sudo make install
- sudo ldconfig

#-------------------------------------------------------------------------------
#Installing gdal 2.0.2
#-------------------------------------------------------------------------------
- cd $INSTALLZ_DIR
- mkdir gdal_install
- export GDAL_INSTALL_DIR=$INSTALLZ_DIR/gdal_install
- wget "http://download.osgeo.org/gdal/2.0.2/gdal-2.0.2.tar.gz"
- tar -xzf gdal-2.0.2.tar.gz
- cd gdal-2.0.2
- ./configure --with-python --prefix=$GDAL_INSTALL_DIR
- make
- make install
- export PATH=$GDAL_INSTALL_DIR/bin:$PATH
- export LD_LIBRARY_PATH=$GDAL_INSTALL_DIR/lib:$PATH
- export GDAL_DATA=$GDAL_INSTALL_DIR/share/gdal

#-------------------------------------------------------------------------------
#Exporting environment variables 
#-------------------------------------------------------------------------------
- cd $INSTALLZ_DIR
- export TACC_NETCDF_LIB=$INSTALLZ_DIR/netcdf-3.6.3-install/lib
- export TACC_NETCDF_INC=$INSTALLZ_DIR/netcdf-3.6.3-install/include
- export PETSC_DIR=$INSTALLZ_DIR/petsc-3.6.2
- export PETSC_ARCH='linux-gcc-cxx'

#-------------------------------------------------------------------------------
#Exporting directories with library-related executables to $PATH
#-------------------------------------------------------------------------------
- export PATH=$PATH:/$PETSC_DIR/$PETSC_ARCH/bin
- export PATH=$PATH:$INSTALLZ_DIR/netcdf-3.6.3-install/bin

#-------------------------------------------------------------------------------
#Installing RAPID
#-------------------------------------------------------------------------------
- cd $TRAVIS_BUILD_DIR
- cd ..
- git clone https://github.com/c-h-david/rapid.git
- cd ./rapid/src/
- make rapid

#*******************************************************************************
#Installing RAPIDpy
#*******************************************************************************
install:
- cd $TRAVIS_BUILD_DIR
- python setup.py install
#*******************************************************************************
#Testing RAPIDpy
#*******************************************************************************
script: nosetests
